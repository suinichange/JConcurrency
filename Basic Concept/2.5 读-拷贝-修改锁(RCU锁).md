## 读一拷贝一修改锁

### 为什么要引入读一拷贝一修改锁（RCU）？

　　不论是常见的读写问题，还是前面所介绍的读写自旋锁，都是允许多个进程同时读，但只要有一个写进程在写，便禁止所有读进程去读，使读者进入阻塞状态。如果写的时间非常长，将严重影响到多个读进程的工作。是否能改善这一情况呢？即使有写进程在写，读进程仍可以去读，不会引起读进程的阻塞。回答是肯定的，其解决方法是改变写进程对文件（共享数据结构）进行修改（写）的方式。此即，当某写进程要往某文件中写入数据时，它先读该文件，将文件的内容拷贝到一个副本上，以后只对副本上的内容进行修改。修改完成后，在适当时侯再将修改完后的文件全部写回去。

### RCU(Read-copy-update)锁

　　RCU锁用来解决读者一写者问题。对于被RCU保护的共享文件（数据结构），无论读者和写者，都是以读的方式对其进行访问的，对于读者而言，不需要获得任何锁就可以访问它，对于写者而言，在访问它时，先制作该文件的一个副本，只对副本上的内容进行修改，然后使用一个回调（ callback）机制，即向系统中一个称为垃圾收集器的机构注册一个回调函数。最后，在适当的时机，由垃圾收集器调用写者注册的回调函数，把指向原来数据的指针重新指向新的被修改的数据，完成最后的数据释放或修改操作。

### 写回时机

　　在RCU锁机构中，如何确定将修改后的内容写回的时机？显然，最好是在所有读者都已完成自己的读任务后再将修改后的文件写回。为此，每一个读者完成对共享文件的操作后，都必须向写者提供一个信号，表示它不再使用该数据结构。当所有的读者都已经发送信号之时，便是所有引用该共享文件的CPU都已退出对该共享数据的操作之时，也就是写者可以将修改后的文件写回之时。对于写者而言，从对副本修改完成后，到执行真正的写修改，中间有一段延退时间，称为写延迟期（ grace period）

### RCU锁的优点

　　RCU实际上是一种改进的读写自旋锁。它的主要优点表现为如下两方面：

　　（1）读者不会被阻塞。读者在访问被RCU保护的共享数据时不会被阻塞。这一方面极大地提高了读进程的运行效率，另一方面也使读者所在的CPU不会发生上下文切换，减少了处理机的开销。

　　（2）无需为共享文件（数据）设置同步机构。在采用该机制时，允许多个读者和一个或多个写者同时访问被保护的数据，无需为共享数据设置同步机构，因而读者没有什么同步开销，也不需要考虑死锁等问题。但是写者的同步开销却比较大，需要复制被修改的数据结构，延迟数据结构的释放，还必须使用某种锁机制，与其它写者的修改操作同步并行。

　　尽管RCU锁对读者带来了很大的好处，但RCU并不能完全替代读写自旋锁。如果读操作较多，而写操作很少，用RCU的确是利大于弊：反之，如果写比较多，对读者的性能提高可能不足以弥补给写者带来的损失，此时还是应当采用读写自旋锁。